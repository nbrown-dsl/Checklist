 
   <script>
   
   /**
   * Run initializations on load.
   */

var acc = document.getElementsByClassName("accordion");
var i;

for (i = 0; i < acc.length; i++) {
  acc[i].addEventListener("click", function() {
    this.classList.toggle("active");
    var panel = this.nextElementSibling;
    if (panel.style.maxHeight){
      panel.style.maxHeight = null;
    } else {
      panel.style.maxHeight = panel.scrollHeight + "px";
    } 
  });
}

 
 
 
 
 
 getWorkFlowTypes();    
 

$('#page1, #page2, #page3, #workflowForm, #newWorkflowdialogue').hide();

 $('.page2button ,#tasks, #fabplus' ).prop( "disabled", true );

$('#tasks').click(function() { $('#tasks').prop( "disabled", true ); $('.page2button').prop( "disabled", false ); checklist();});

$('#backhome').click(function() { $('#tasks').prop( "disabled", false ); returnHome();});

$('#userType').change(function() { $('#newStudentSubmit').prop( "disabled", false );});

$('#fabplus').click(function() { addUser() });

$('#newWorkflow').click(function() { addWorkflow() });

$('#close').click(function() { $('#page3').hide(500); });

$('#archive').click(function() { archive() });

$('#update').click(function() { save() });

$('#search').click(function() { search() });



//creates new user and adds to list
$('#newStudentSubmit').click(function() {  

    $('#newStudentSubmit').prop( "disabled", true );
            
            google.script.run
            .withSuccessHandler(function(response){ $('#page3').hide(1000); confirm(response); studentList(); })
            .processForm(this.parentNode)
            
            });

//shows relevant list in response to click on protocol choice in sidebar
$('.workflow').click(function() {  var workflow = $(this).attr('value'); studentList(workflow) }); 

//onload gets list of workflow types and task sheets
function getWorkFlowTypes() {

google.script.run
            .withSuccessHandler(function(workflowtypes) {
             
        workflowtypes.map(function(workflowName) { 
       
      // $('#typesOfWorkflow').append(" <a class='mdl-navigation__link workflowType' value="+workflowName+">"+workflowName+"</a>")
       $('<a/>', { class:'mdl-navigation__link workflowType', value: workflowName, text:workflowName }).appendTo('#typesOfWorkflow');
        });
        
        // NEW shows relevant list in response to click on protocol choice in sidebar
       $('.workflowType').click(function() {  var workflowType = $(this).attr('value'); workflowList(workflowType) }); 
          
          })
       .withFailureHandler(function(msg) {
            // Respond to failure conditions here.
           console.log(msg)          
          })
            .listOfWorkFlows(); 
}


//shows add workflow dialogue
function addWorkflow() {

google.script.run
            .withSuccessHandler(function(formData) {          
              $('#newWorkflowdialogue').show(1000);          
              })
            .withFailureHandler(function(msg) {
              // Respond to failure conditions here.
              $('#newWorkflowdialogue').html(msg);
              $('#newWorkflowdialogue').show(1000);         
            })
            .getFormData(); 
        }


//shows add to list form
function addUser() {

google.script.run
            .withSuccessHandler(function(formData) {
            
             $('.studentForm').empty();
             $('#page3').show(1000);
                        
          })
       .withFailureHandler(function(msg) {
            // Respond to failure conditions here.
            $('#workflowForm').html(msg);
            $('#page3').show(1000);
           
          })
            .getFormData(); 

}

// called when protocol type selected from sidebar, passes prtocol type (workflow parameter)
function studentList(workflow) {

    $('#newStudentSubmit, .page2button ,#tasks' ).prop( "disabled", true );
    $('#page2, #page1').hide();
    $('#fabplus').prop( "disabled", false );
    $('#workflow_type').text(workflow);
   
google.script.run
            .withSuccessHandler(function(students) {
            // Respond to success conditions here.
           
              createRadioboxes(students);
              $('#page1').show(1000);
              $('#tasks').prop( "disabled", false );
          })
       .withFailureHandler(function(msg) {
            // Respond to failure conditions here.
            $('#listofusers').show();
             $('#listofusers').html(msg);
          })
            .findStudents(workflow); 


}

// NEW called when protocol type selected from sidebar, passes prtocol type (workflow parameter) and filters list of workflows

function workflowList(workflowType) {

    $('#newStudentSubmit, .page2button ,#tasks' ).prop( "disabled", true );
    $('#page2, #page1').hide();
    $('#fabplus').prop( "disabled", false );
    $('#workflow_type').text(workflowType);
   
google.script.run
            .withSuccessHandler(function(tasks) {
            // Respond to success conditions here.
           allTasksList(tasks);
           $('#page2').show(1000);
            //  createRadioboxes(students);
            //  $('#page1').show(1000);
              $('#tasks').prop( "disabled", false );
          })
       .withFailureHandler(function(msg) {
            // Respond to failure conditions here.
            $('#listofusers').show();
             $('#listofusers').html(msg);
          })
            .allTasks(workflowType); 


}

//NEW creates list of all tasks in table for each workflow

function XallTasksList(tasks) {

var taskNumber = tasks.length;
   var id="";
 $('#workFlow_info').empty();

//create table for each workflow and assign workflowname as table id
 var firstColumn = tasks.map(function(e) { return e[0] });
 var unique = firstColumn.filter( function (value, index, self) { 
               return self.indexOf(value) === index;});

unique.map(function(e,i) {

var workflowInfo_object = JSON.parse(e.replace(/=/g,":"));
var WFid = workflowInfo_object["workflow_name"].replace(/ /g,"");

$('#taskTableTemplate').clone().attr({
  id: WFid
}).appendTo('#page2');

 var i;
 for (i in workflowInfo_object) {
 var table = "#"+WFid;
 $('<h6 />').html(workflowInfo_object[i]).insertBefore(table);
 }

});


   var container = $('tbody').on( "click", "input.taskDone", addUsername).empty();
   
   //add row to appropriate table for each task

 for (var f=1; f<taskNumber ; f++) {
 
 var workflowInfo_objectRow = JSON.parse(tasks[f][0].replace(/=/g,":"));
 var WFidRow = workflowInfo_objectRow["workflow_name"].replace(/ /g,"");

      id = WFidRow+f;
     $('<tr />',{id: 'row'+id, value: tasks[f][0]}).appendTo("#"+WFidRow+">tbody");
     var row = $("#row"+id);
     var checkBox = $('<td />', { class:'checkboxRow' }).appendTo(row);
     $('<input />', { class:'taskDone', type: 'checkbox', id: id, value: tasks[f][1] }).appendTo(checkBox);
     if (tasks[f][3]) {$('#'+id).prop('checked',true);}; // if task has a username in next cell checked as done
     
     var taskdescrip = $('<td />', { class:'taskdescrip' }).appendTo(row);
     $('<input />', { class:'taskDesc taskdescriptions', 'for': id, type: 'text',value: tasks[f][1] }).appendTo(taskdescrip);
    
     var usernameResp = $('<td />', { class:'usernameResp' }).appendTo(row);
     $('<input />', { id: 'taskResps'+id, class:'taskResps', type: 'text', value: tasks[f][2] }).appendTo(usernameResp);
     
     $('<td />',{ id: 'username'+id, class:'username', html:tasks[f][3]}).appendTo(row);
     }

 }

function returnHome() {

    $('#newStudentSubmit, .page2button').prop( "disabled", true );
    $('#page2').hide();
    $('#page1').show(1000);
    $('#fabplus, #tasks').prop( "disabled", false );

}



//shows checklist of selected student
function checklist() {

 $('#page1, #page3').hide(1000);
 $('#fabplus').prop( "disabled", true );
 $('#output').empty();
 
  var student = $('input[type="radio"]:checked').val();
    
   google.script.run
            .withSuccessHandler(function(tasks) {
            // Respond to success conditions here.
           
              createCheckboxes(tasks);
              $('#page2').show(1000);
          })
       .withFailureHandler(function(msg) {
            // Respond to failure conditions here.
            $('#output').show();
             $('#output').html(msg);
          })
            .tasks(student); 
  
 }
 
 //NEW NEW all tasks tables
 //tasks all in one table
  function XallTasksList(tasks) {
  
   var container = $('#output');
   var taskNumber = tasks.length;
   var id="";

 for (var f=2; f<taskNumber ; f++) {

  id = 'tasks'+f;
     $('<tr />',{id: 'row'+f}).appendTo(container);
     var row = $("#row"+f);
     var checkBox = $('<td />', { class:'checkboxRow' }).appendTo(row);
     $('<input />', { class:'taskDone', type: 'checkbox', id: id, value: tasks[f][1] }).appendTo(checkBox);
     if (tasks[f][3]) {$('#'+id).prop('checked',true);}; // if task has a username in next cell checked as done
     
     var taskdescrip = $('<td />', { class:'taskdescrip' }).appendTo(row);
     $('<input />', { class:'taskDesc taskdescriptions', 'for': id, type: 'text',value: tasks[f][1] }).appendTo(taskdescrip);
    
     var usernameResp = $('<td />', { class:'usernameResp' }).appendTo(row);
     $('<input />', { id: 'taskResps'+f, class:'taskResps', type: 'text', value: tasks[f][2] }).appendTo(usernameResp);
     
     $('<td />',{ id: 'username'+f, class:'username', html:tasks[f][3]}).appendTo(row);
     }

 }
 
 //NEW NEW filter all tasks table
 
 function myFunction() {
  // Declare variables 
  var input, filter, table, tr, td, i;
  input = document.getElementById("myInput");
  filter = input.value.toUpperCase();
  table = document.getElementById("output");
  tr = table.getElementsByTagName("tr");

  // Loop through all table rows, and hide those who don't match the search query
  for (i = 0; i < tr.length; i++) {
    td = tr[i].getElementsByTagName("td")[0];
    
    if (td) {
      if (td.innerHTML.toUpperCase().indexOf(filter) > -1) {
        tr[i].style.display = "";
      } else {
        tr[i].style.display = "none";
      }
    } 
  }
}

//SUPER NEW cards
//card for each workflow

function allTasksList(tasks) {

var taskNumber = tasks.length;
   var id="";
 $('#workFlow_info').empty();

//create table for each workflow and assign workflowname as table id
 var firstColumn = tasks.map(function(e) { return e[0] });
 var unique = firstColumn.filter( function (value, index, self) { 
               return self.indexOf(value) === index;});

unique.map(function(e,i) {

var workflowInfo_object = JSON.parse(e.replace(/=/g,":"));
var WFid = workflowInfo_object["workflow_name"].replace(/ /g,"");

$('#workflowCard_template').clone().attr({
  id: WFid
}).appendTo('#cards');

var table = "#"+WFid;
 $(table).removeClass('template');
 $(table + ' .mdl-card__title').css('background-color', '#'+Math.floor(Math.random()*16777215).toString(16));
 $(table+' .mdl-card__title').html(workflowInfo_object["workflow_name"]);
 $(table + ' .viewTasksButton').click(function() {
      var dialogTasks = document.querySelector('#tasklistdialogue');
      dialogTasks.showModal();
    });

 $(table +'>.cardText').empty();
 var i;
 for (i in workflowInfo_object) {
 if (i !='workflow_type' && i !='workflow_name' && i !='tasks_sheetName') {
 $('<p />').html(i+":"+workflowInfo_object[i]).appendTo(table +'>.cardText');
 }
 }

});



 }
 
 function createCheckboxes(tasks) {
 
 $('#studentName').html(tasks[0][0]); //student name
 $('#yearGroup').html(tasks[0][1]); //year group
 $('#enrollmentDate').html(tasks[0][2]); //year group
  
   var container = $('#output');
   var taskNumber = tasks.length;
   var id="";

 for (var f=2; f<taskNumber ; f++) {

  id = 'tasks'+f;
     $('<tr />',{id: 'row'+f}).appendTo(container);
     var row = $("#row"+f);
     var checkBox = $('<td />', { class:'checkboxRow' }).appendTo(row);
     $('<input />', { class:'taskDone', type: 'checkbox', id: id, value: tasks[f][0] }).appendTo(checkBox);
     if (tasks[f][1]) {$('#'+id).prop('checked',true);}; // if task has a username in next cell checked as done
     
     var taskdescrip = $('<td />', { class:'taskdescrip' }).appendTo(row);
     $('<input />', { class:'taskDesc taskdescriptions', 'for': id, type: 'text',value: tasks[f][0] }).appendTo(taskdescrip);
    
     var usernameResp = $('<td />', { class:'usernameResp' }).appendTo(row);
     $('<input />', { id: 'taskResps'+f, class:'taskResps', type: 'text', value: tasks[f][2] }).appendTo(usernameResp);
     
     $('<td />',{ id: 'username'+f, class:'username', html:tasks[f][1]}).appendTo(row);
     }

 }
 
 //adds username next to task when checkbox checked , or removes when unchecked
 
$( "#output" ).on( "click", "input.taskDone", addUsername);

function addUsername () {

   console.log('clicked');
var $this = $(this);
 var selector = $this.parent().nextAll(".username"); //finds username element in line with clicked input
 
if ($this.prop('checked')) { //if task checked add username of active user to end of task desc
 
 google.script.run
            .withSuccessHandler(function(user) {
            // Respond to success conditions here.
           selector.html(user);
           // call save function every time change to list (but what about editting description? 
           // have email list as separate function called by 'email' button
           // save();
          })
          .activeUser();
          
          }
          
 else { selector.empty();   }    //if unchecked, removes username  
 
}
 
// archives student by adding '*' to sheet name

  function archive() {
  
  $('#archive, #tasks').prop( "disabled", true );
  
  
  var student = $('#studentName').text();
  
  google.script.run
            .withSuccessHandler(function(success) {
            
           studentList() 
           confirm(success + " has been archived");
           returnHome();
            })
            .archiveStudent(student);
            
  }
 
//maps task list and usernames to array and sets as values in appropriate sheet 
 
  function save() {
  
  $('#update').prop( "disabled", true );
  
  
 var student = $('#studentName').text();
 
 

var tasks =[];
$('.taskdescriptions').each(function(index, obj)
{
  tasks.push($(this).val());
});

 var usernames =[];
$('.username').each(function(index, obj)
{
  usernames.push($(this).text());
});

 var responsibility = [];
$('.taskResps').each(function(index, obj)
{
  responsibility.push($(this).val());
});


$('input').remove('.taskDone');
var tasksHtml = $('table').html();


  google.script.run
            .withSuccessHandler(function(success) {
            // Respond to success conditions here.
             $('#update').prop( "disabled", false );
             $('#spinner').hide();
             confirm(success);
          })
       .withFailureHandler(function(msg) {
            // Respond to failure conditions here.
             $('#update').prop( "disabled", false );
             $('#spinner').hide();
             $('#updateResponse').show();
             $('#updateResponse').html(msg);
          })
            .tableToSpreadsheet(student,tasks,usernames,responsibility,tasksHtml)
    }
 
 
 function search() { 
    
    $('#students').show();
    $('#students').html('searching....');
    var searchterm= $("form input:text").val();
    
   google.script.run
            .withSuccessHandler(function(studentsFound) {
            // Respond to success conditions here.
            $('#students').show();
              createRadioboxes(studentsFound);
             
          })
       .withFailureHandler(function(msg) {
            // Respond to failure conditions here.
            $('#students').show();
             $('#students').html(msg);
          })
            .findStudents(searchterm) 
  
 }
 
 //list of sheets of students as radio boxes to select
 
 function createRadioboxes(studentsFound) {  
 
   $('.item-on-list').remove();
   var container = $('#listofusers');
   var taskNumber = studentsFound.length;
   
   for (var f=0; f<taskNumber ; f++) {

     var id = "student"+f;
    
     
     $('#user-on-list').clone().appendTo(container).attr( { 'id':id, 'class': 'item-on-list'});
     $('#'+id+' .user-name').text(studentsFound[f]);
     $('#'+id+' input').attr({ id:id , value: studentsFound[f] });
     $('#'+id+' label').attr('for',id);
     $('.item-on-list').show();
    
     }
     
      $('#user-on-list').hide();
      
    
     }
                 
     
 //snackbar confirmation     
      
      function confirm(response) {
      
       'use strict';
  window['counter'] = 0;
  
    var snackbarContainer = document.querySelector('#demo-toast-example');
    var data = {message: response };
    snackbarContainer.MaterialSnackbar.showSnackbar(data);
      }

    </script>



