<script>

    var dialog = document.querySelector('dialog');
    var showModalButton = document.querySelector('.show-modal');
    if (! dialog.showModal) {
      dialogPolyfill.registerDialog(dialog);
    }
    
    $('.workflowEntry').hide();
    $('#workflowList').hide(1000).empty();
    
    
    showModalButton.addEventListener('click', function() {
    $('.newWorkflowdialoguePage').hide().removeClass('current');
    $('#workflowdialogue_page1_type').show().addClass('current');
    $('.back').prop( "disabled", true );
    $('.next, .createWorkFlow').prop( "disabled", false );
    
      dialog.showModal();
    });
    dialog.querySelector('.close').addEventListener('click', function() {
      dialog.close();
    });
    dialog.querySelector('.next').addEventListener('click', function() {
    
     updateWorkflowSelected()
     
              $('.current').hide().removeClass('current').next().show(500).addClass('current');
              $('.back').prop( "disabled", false );
              if ( $('.current').hasClass("lastPage")) { $('.next').prop( "disabled", true );    }
              
             
             
    });
    
    //delete workflow button
     dialog.querySelector('#deleteWorkflow').addEventListener('click', function() { deleteWorkFlow() });
    
    
    //sets document properties from new workflow form fields
    
     dialog.querySelector('.createWorkFlow').addEventListener('click', function() {
     
      $('.createWorkFlow').prop( "disabled", false );
     
    var unindexed_array = $('.new_form').serializeArray();
    
    var indexed_array = {};
    $.map(unindexed_array, function(n, i){
        indexed_array["\""+n["name"]+"\""] = "\""+n["value"]+"\"";
    });   
        google.script.run
            .withSuccessHandler(function(response){ 
            
            dialog.close(1000);
            confirm(response);
       
           })
           .withFailureHandler(function(msg) {
            // Respond to failure conditions here.
            console.log(msg);
          })
            .processworkflowForm(indexed_array)
            
    });
    
    dialog.querySelector('.back').addEventListener('click', function() {
              $('.current').hide().removeClass('current').prev().show(500).addClass('current');
              $('.next').prop( "disabled", false );
              if ( $('.current').hasClass("firstPage")) { $('.back').prop( "disabled", true );    }
              
              updateWorkflowSelected()
    });
    dialog.querySelector('#addEntry').addEventListener('click', function() {
              addEntry();
    });
     dialog.querySelector('#removeEntry').addEventListener('click', function() {
              removeEntry();
    });
    
    
    //adds new workflow tasks and properties to spreadsheet
     dialog.querySelector('#newStudentSubmit').addEventListener('click', function() {
              $('#newStudentSubmit').prop( "disabled", true );
              var formArray = $('#myForm2').serializeArray();
            
             var formArrayIndex = {};
    $.map(formArray, function(n, i){
        formArrayIndex["\""+n["name"]+"\""] = "\""+n["value"]+"\"";
           });     
              
              var workFlowName =  $('#workflowName').attr('value');
  google.script.run
            .withSuccessHandler(function(response){ dialog.close(1000); confirm(response); studentList(); })
            .processWorkflow(formArrayIndex,workFlowName)
  
    });
    
    workflowTypelist();
       
    //appends list of workflows from doc properties keys upon initialization
function workflowTypelist() {
 google.script.run
            .withSuccessHandler(function(list){ 
            
           
            
            for (var l=0; l<list.length; l++) {
            $('<option />', { value:list[l], text:list[l] }).appendTo('#workflowList');
            //$('#workflowList').append('<a class="workflowEdit" value="'+list[l]+'"><i class="material-icons">mode_edit</i></a>');
            }; 
             $('<option />', { value:'new', text:'New type of workflow' }).appendTo('#workflowList');
             $('#workflowList').show(1000)
           })
           .withFailureHandler(function(msg) {
            // Respond to failure conditions here.
             $('#workflowList').html(msg);
          })
            .listOfWorkFlows();
            
            }
  
  //new workflow submitted, spreadsheet rows added, workflow list updated
  function submitWorkflow() {
  $('#newStudentSubmit').prop( "disabled", true );
  google.script.run
            .withSuccessHandler(function(response){ dialog.close(1000); confirm(response); studentList(); })
            .processForm(this.parentNode)
  
  
  }
            
 //adds blank form field to edit page 
 function addEntry(description,option) {
 
 $('#removeEntry').prop( "disabled", false );
 
 var newEntry =   $('.workflowEntry:first').clone()
 
 var entryNumber = $('.workflowEntry').length + 1;
 
 newEntry.children('.entryDescription').attr({ name: 'entryDescription'+entryNumber, value:description} ); 
 newEntry.children('.entryOption').attr({ name: 'entryOption'+entryNumber, value: option}); 
 
 newEntry.appendTo('#formEntryFields').fadeIn(1000);
 
 if ( entryNumber >6 ) { 
  $('#addEntry').prop( "disabled", true );
  }
  
}

//remove last form field

function removeEntry() {
 
 if ($('.workflowEntry').length>1) { $('.workflowEntry:last').remove();}
  if ($('.workflowEntry').length==1) { $('#removeEntry').prop( "disabled", true );}
  
 $('#addEntry').prop( "disabled", false );
 
 }


//presents form according to workflow selection on first page
function updateWorkflowSelected() {

var str = "";
    $( "#workflowList option:selected" ).each(function() {
      str += $( this ).text() + " ";
    });
    
    $( ".workflowFormName" ).text(str);
    $( "#workflowFormFields, #formEntryFields" ).empty();
    
     google.script.run
            .withSuccessHandler(function(response){ 
            
        var formString = response.replace(/=/g, ":");
         var formFields = JSON.parse(formString);   
                
  //creates form field elements and edit form elements from formField object properties
              
          $('<h4 />', { class:'formFieldLabel', text: 'Form for '+formFields['workflow_name'] }).appendTo('#workflowFormFields');
          $('#workflowName').attr('value', formFields['workflow_name']);
           $('<input />', { class:'formFieldInput', type: 'text', name: 'tasks_sheetName', value:formFields['tasks_sheetName']  }).appendTo('#workflowFormFields');

          for (var entries = 2; entries < 8; entries++) {
          
          var entryOption = 'entryOption'+entries;
          var entryDescription = 'entryDescription'+entries;    
          
          if (!formFields[entryOption]) { break };
          
         addEntry(formFields[entryDescription],formFields[entryOption]) 
           
          if (formFields[entryOption] == "Text" || formFields[entryOption] == "Date" ) {
                $('<label />', { class:'formFieldLabel', text:formFields[entryDescription] }).appendTo('#workflowFormFields');
                $('<input />', { class:'formFieldInput', type: formFields[entryOption].toLowerCase(), name: formFields[entryDescription]  }).appendTo('#workflowFormFields');
                $('<br>').appendTo('#workflowFormFields');
             }
    
          else if (formFields[entryOption].indexOf("@")>-1) {
                $('<label />', { class:'formFieldLabel', text:formFields[entryDescription] }).appendTo('#workflowFormFields');
                var selectOptionsArray = formFields[entryOption].split('@');
                selectOptionsArray.map(function(i,v) {
                $('<input />', { class:'formFieldInput', type: 'radio', value: selectOptionsArray[i], name: formFields[entryDescription] }).appendTo('#workflowFormFields');
                $('<p/>', { class:'formFieldInput', text:selectOptionsArray[i] }).appendTo('#workflowFormFields');
                });
           }
           
           else if (formFields[entryOption].indexOf(",")>-1) {
                $('<label />', { class:'formFieldLabel', text:formFields[entryDescription] }).appendTo('#workflowFormFields');
                var selectID = formFields[entryDescription].replace(" ","");
                $('<select />', { class:'formFieldSelect', id:selectID, name: formFields[entryDescription]}).appendTo('#workflowFormFields');
                var selectOptionsArray = formFields[entryOption].split(',');
                selectOptionsArray.map(function(optionValue) {
                $('<option />', { class:'formFieldInput', value: optionValue, text: optionValue }).appendTo('#'+selectID);
                
                });
           }
           
           }
            
           })
           .withFailureHandler(function(msg) {
            // Respond to failure conditions here.
          $( "#workflowFormFields" ).text(msg);
          })
            .getworkflowForm(str);
    
    
  }
  
      //deletes workflow from doc properties 
function deleteWorkFlow() {

dialog.close();
var workflowName = $(".workflowFormName:first").text();

 google.script.run
            .withSuccessHandler(function(response){ 
           
            confirm(response)
            
           })
           .withFailureHandler(function(msg) {
            // Respond to failure conditions here.
            console.log(msg);
          })
            .deleteWorkFlow(workflowName);
            
            }


    
  </script>

