<script>

    var dialog = document.querySelector('dialog');
    var showModalButton = document.querySelector('.show-modal');
    if (! dialog.showModal) {
      dialogPolyfill.registerDialog(dialog);
    }
    
    $('.workflowEntry').hide();
    $('#workflowList').hide(1000).empty();
    
    
    showModalButton.addEventListener('click', function() {
    $('.newWorkflowdialoguePage').hide().removeClass('current');
    $('#workflowdialogue_page1_type').show().addClass('current');
    $('.back').prop( "disabled", true );
    $('.next, .createWorkFlow').prop( "disabled", false );
    
      dialog.showModal();
    });
    dialog.querySelector('.close').addEventListener('click', function() {
      dialog.close();
    });
    dialog.querySelector('.next').addEventListener('click', function() {
    
     updateWorkflowSelected()
     
              $('.current').hide().removeClass('current').next().show(500).addClass('current');
              $('.back').prop( "disabled", false );
              if ( $('.current').hasClass("lastPage")) { $('.next').prop( "disabled", true );    }
              
             
             
    });
    
    //delete workflow button
     dialog.querySelector('#deleteWorkflow').addEventListener('click', function() { deleteWorkFlow() });
    
    
    //sets document properties from new workflow form fields
    
     dialog.querySelector('.createWorkFlow').addEventListener('click', function() {
     
      $('.createWorkFlow').prop( "disabled", false );
     
    var unindexed_array = $('.new_form').serializeArray();
    
    var indexed_array = {};
    $.map(unindexed_array, function(n, i){
        indexed_array["\""+n["name"]+"\""] = "\""+n["value"]+"\"";
        
    });
    
    console.log(indexed_array);

                google.script.run
            .withSuccessHandler(function(response){ 
            
            dialog.close(1000);
            confirm(response +" workflow created");
             
           
           })
           .withFailureHandler(function(msg) {
            // Respond to failure conditions here.
            console.log(msg);
          })
            .processworkflowForm(indexed_array)
            
            
    });
    
    dialog.querySelector('.back').addEventListener('click', function() {
              $('.current').hide().removeClass('current').prev().show(500).addClass('current');
              $('.next').prop( "disabled", false );
              if ( $('.current').hasClass("firstPage")) { $('.back').prop( "disabled", true );    }
              
              updateWorkflowSelected()
    });
    dialog.querySelector('#addEntry').addEventListener('click', function() {
              addEntry();
    });

    
    
    //     dialog.querySelector('#workflowList').addEventListener('change', function() {
//              updateWorkflowSelected();
//    });
//  
    
    
    
    workflowlist();
    
    //appends list of workflows from doc properties keys
function workflowlist() {
 google.script.run
            .withSuccessHandler(function(list){ 
            
           
            
            for (var l=0; l<list.length; l++) {
            $('<option />', { value:list[l], text:list[l] }).appendTo('#workflowList');
            //$('#workflowList').append('<a class="workflowEdit" value="'+list[l]+'"><i class="material-icons">mode_edit</i></a>');
            }; 
             $('<option />', { value:'new', text:'New type of workflow' }).appendTo('#workflowList');
             $('#workflowList').show(1000)
           })
           .withFailureHandler(function(msg) {
            // Respond to failure conditions here.
             $('#workflowList').html(msg);
          })
            .listOfWorkFlows();
            
            }
    
 function addEntry() {
 
 var newEntry =   $('.workflowEntry:first').clone()
 
 var entryNumber = $('.workflowEntry').length + 1;
 
 newEntry.children('.entryDescription').attr('name','entryDescription'+entryNumber); 
 newEntry.children('.entryOption').attr('name','entryOption'+entryNumber); 
 
 newEntry.appendTo('#workflowFormDialogueEdit').fadeIn(1000);

}


//presents form according to workflow selection on first page
function updateWorkflowSelected() {

var str = "";
    $( "#workflowList option:selected" ).each(function() {
      str += $( this ).text() + " ";
    });
    
    $( ".workflowFormName" ).text(str);
    $( "#workflowFormFields" ).empty();
    
     google.script.run
            .withSuccessHandler(function(response){ 
            
        var formString = response.replace(/=/g, ":");
         var formFields = JSON.parse(formString);   
          
          $('#workflowFormFields').append('<div>'+formString+'</div>');
           console.log(formFields);
           console.log(typeof formFields);
         
           for (var field in formFields ) { 
            
             $('<label />', { class:'formFieldLabel', text: formFields[field] }).appendTo('#workflowFormFields');
             $('<br>').appendTo('#workflowFormFields');
            
            }
           
           
            
           })
           .withFailureHandler(function(msg) {
            // Respond to failure conditions here.
          $( "#workflowFormFields" ).text(msg);
          })
            .getworkflowForm(str);
    
    
  }
  
      //deletes workflow from doc properties 
function deleteWorkFlow() {

dialog.close();
var workflowName = $(".workflowFormName:first").text();

console.log( typeof workflowName);

 google.script.run
            .withSuccessHandler(function(response){ 
           
            confirm(response)
            
           })
           .withFailureHandler(function(msg) {
            // Respond to failure conditions here.
            console.log(msg);
          })
            .deleteWorkFlow(workflowName);
            
            }


    
  </script>

